<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race Admin | WHY RACING EVENTS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Oswald:wght@500;700&display=swap"
        rel="stylesheet">
    <link href="../../assets/css/admin-global.css" rel="stylesheet">
    <script src="../../assets/js/nav.js"></script>
</head>

<body>

    <!-- Password Gate -->
    <div class="password-gate" id="passwordGate">
        <div class="password-box">
            <img src="../../images/logos/new-why-racing-logo.png" alt="WHY RACING EVENTS Logo" class="logo-placeholder">
            <h1>Race Admin Panel</h1>
            <p>Enter password to access the dashboard</p>
            <input type="password" id="passwordInput" placeholder="Password"
                onkeypress="if(event.key==='Enter')checkPassword()">
            <button onclick="checkPassword()">Enter Dashboard</button>
            <p class="password-error" id="passwordError">Incorrect password. Try again.</p>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div class="admin-dashboard" id="adminDashboard">
        <div id="adminNavContainer"></div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('races')">All Races</button>
            <button class="tab-btn" onclick="switchTab('add')">+ Add New Race</button>
        </div>

        <!-- Tab: Race List -->
        <div class="tab-content active" id="tab-races">
            <div class="race-list" id="raceList">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Tab: Add/Edit Race -->
        <div class="tab-content" id="tab-add">
            <form id="raceForm">

                <!-- Visibility & Status -->
                <div class="form-section">
                    <h2>üìã Visibility & Status</h2>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="isActive" checked>
                            <span>Race visible on site</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="registrationOpen">
                            <span>Registration open</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="isFeatured">
                            <span>Featured on homepage</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="waitlistEnabled">
                            <span>Waitlist enabled when full</span>
                        </label>
                    </div>
                </div>

                <!-- Basic Info -->
                <div class="form-section">
                    <h2>üìù Basic Information</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="raceName">Race Name *</label>
                            <input type="text" id="raceName" name="raceName" placeholder="e.g., Haunted Half Marathon"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="raceDate">Race Date *</label>
                            <input type="date" id="raceDate" name="raceDate" required>
                        </div>

                        <div class="form-group">
                            <label for="raceType">Race Type</label>
                            <select id="raceType" name="raceType">
                                <option value="running">Running</option>
                                <option value="trail">Trail Running</option>
                                <option value="triathlon">Triathlon</option>
                                <option value="duathlon">Duathlon</option>
                                <option value="kids">Kids Race</option>
                                <option value="virtual">Virtual</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="venue">Venue Name</label>
                            <input type="text" id="venue" name="venue" placeholder="e.g., Lacamas Lake Regional Park">
                        </div>

                        <div class="form-group">
                            <label for="city">City</label>
                            <input type="text" id="city" name="city" placeholder="e.g., Camas">
                        </div>
                        <div class="form-group">
                            <label for="state">State</label>
                            <select id="state" name="state">
                                <option value="WA">Washington</option>
                                <option value="OR">Oregon</option>
                                <option value="ID">Idaho</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label for="distances_display">Distances (Event Card Display)</label>
                            <input type="text" id="distances_display" name="distances"
                                placeholder="e.g., 5K, 10K, Half Marathon">
                        </div>




                        <div class="form-group full-width">
                            <label for="registrationUrl">Registration URL (RunSignUp) *</label>
                            <input type="url" id="registrationUrl" name="registrationUrl"
                                placeholder="https://runsignup.com/Race/WA/Vancouver/YourRaceName">
                            <small class="help-text">Paste the full RunSignUp URL
                                where
                                participants can register</small>
                        </div>
                    </div>
                </div>

                <!-- Distances & Pricing -->
                <div class="form-section">
                    <h2>üèÖ Distances & Pricing</h2>
                    <div class="distance-list" id="distanceList">
                        <div class="distance-item">
                            <div>
                                <label>Distance Type</label>
                                <select name="distanceName[]" aria-label="Distance Type"
                                    onchange="autoFillDistance(this)" class="full-width-select">
                                    <option value="">-- Select Distance --</option>
                                    <option value="5K">5K</option>
                                    <option value="10K">10K</option>
                                    <option value="15K">15K</option>
                                    <option value="Half Marathon">Half Marathon</option>
                                    <option value="Marathon">Marathon</option>
                                    <option value="50K Ultra">50K Ultra</option>
                                    <option value="100K Ultra">100K Ultra</option>
                                    <option value="100 Mile">100 Mile</option>
                                    <option value="Kids Run">Kids Run</option>
                                    <option value="1 Mile">1 Mile</option>
                                    <option value="Sprint Triathlon">Sprint Triathlon</option>
                                    <option value="Olympic Triathlon">Olympic Triathlon</option>
                                    <option value="Half Ironman">Half Ironman</option>
                                    <option value="Trail Run">Trail Run</option>
                                    <option value="Virtual">Virtual</option>
                                </select>
                            </div>
                            <div>
                                <label>Distance Value</label>
                                <input type="text" name="distanceValue[]" placeholder="e.g., 3.1 miles">
                            </div>

                            <div>
                                <label>Base Price</label>
                                <input type="number" name="distancePrice[]" placeholder="75" step="0.01">
                            </div>

                            <button type="button" class="remove-distance" onclick="removeDistance(this)">√ó</button>
                        </div>
                    </div>
                    <button type="button" class="add-distance" onclick="addDistance()">+ Add Another Distance</button>
                </div>







                <!-- Beneficiaries & Sponsors -->
                <div class="form-section">
                    <h2>ü§ù Partners & Causes</h2>

                    <div class="repeater-container">
                        <h3>‚ù§Ô∏è Beneficiaries</h3>
                        <div id="beneficiaryList" class="repeater-list">
                            <!-- Populated by JS -->
                        </div>
                        <button type="button" class="add-btn" onclick="addBeneficiary()">+ Add Beneficiary</button>
                    </div>

                    <div class="repeater-container mt-30">
                        <h3>ü§ù Sponsors</h3>
                        <div id="sponsorList" class="repeater-list">
                            <!-- Populated by JS -->
                        </div>
                        <button type="button" class="add-btn" onclick="addSponsor()">+ Add Sponsor</button>
                    </div>
                </div>







                <!-- Media -->
                <div class="form-section">
                    <h2>üì∏ Media</h2>







                    <!-- Thumbnail Image -->
                    <div class="media-block">
                        <h4>üè∑Ô∏è Race Thumbnail</h4>
                        <p class="media-hint">Square image for race cards and listings (recommended: 800x800)</p>
                        <div class="form-group">
                            <div class="image-upload-area thumbnail-upload" id="thumbnailUploadArea"
                                onclick="document.getElementById('thumbnailImage').click()">
                                <input type="file" id="thumbnailImage" name="thumbnailImage" accept="image/*"
                                    onchange="previewImage(this, 'thumbnailPreview')" hidden>
                                <div class="upload-placeholder" id="thumbnailPlaceholder">
                                    <span>üìÅ</span>
                                    <p>Click to upload</p>
                                    <small>Square image</small>
                                </div>
                                <img id="thumbnailPreview" alt="Race thumbnail preview"
                                    class="image-preview display-none">
                            </div>
                            <button type="button" class="clear-image-btn display-none" onclick="clearImage('thumbnail')"
                                id="thumbnailClearBtn">‚úï Remove</button>
                        </div>
                    </div>


                </div>



                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
                    <button type="button" class="btn btn-secondary display-none" id="viewLiveBtn"
                        onclick="window.open('../events/race-detail.html?id=' + document.getElementById('raceForm').dataset.editingId, '_blank')">View
                        Live</button>
                    <button type="button" class="btn btn-secondary" onclick="saveDraft()">Save as Draft</button>
                    <button type="submit" class="btn btn-primary">Save & Publish Race</button>
                </div>

                <!-- Delete Section (only visible when editing) -->
                <div id="deleteSection" class="display-none mt-40 pt-30 danger-border-top">
                    <h4 class="color-red-danger mb-15">‚ö†Ô∏è Danger Zone</h4>
                    <p class="color-slate mb-15">Permanently delete this race and all associated
                        data. This action cannot be undone.</p>

                    <!-- Step 1: Initial Button -->
                    <div id="deleteStep1">
                        <button type="button" class="btn btn-danger-outline" onclick="showDeleteConfirm()">
                            üóëÔ∏è Delete This Race
                        </button>
                    </div>

                    <!-- Step 2: Confirmation Buttons -->
                    <div id="deleteStep2" class="display-none danger-confirm-box">
                        <p class="danger-confirm-text">Are you absolutely sure? This
                            cannot be undone.</p>
                        <div class="flex-centered-gap-8">
                            <button type="button" class="btn btn-danger-solid" onclick="finalDeleteRace()">
                                YES, DELETE PERMANENTLY
                            </button>
                            <button type="button" class="btn btn-secondary"
                                onclick="hideDeleteConfirm()">Cancel</button>
                        </div>
                    </div>
                </div>

            </form>
        </div>

    </div>

    <script type="module">
        import { checkAuth, login } from '../../assets/js/admin-auth.js';
        import { renderAdminNav } from '../../assets/js/admin-nav.js';

        // Specific API endpoints for this page
        const AI_ENDPOINT = '/api/generate-theme';
        const RACES_ENDPOINT = '/api/races';

        // Check authentication
        if (checkAuth(false)) { // false means don't redirect, just check
            document.getElementById('passwordGate').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            renderAdminNav('races');
            loadRaces();
        }

        // Attach login to window for the onclick handler
        window.checkPassword = async function () {
            const input = document.getElementById('passwordInput');
            if (await login(input.value)) {
                document.getElementById('passwordGate').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
                renderAdminNav('races');
                loadRaces();
            } else {
                document.getElementById('passwordError').style.display = 'block';
                input.value = '';
            }
        };

        // === Tab Navigation ===
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Handle the case where switchTab is called via onclick="(event) => switchTab(...)"
            if (typeof event !== 'undefined' && event.target && event.target.classList.contains('tab-btn')) {
                event.target.classList.add('active');
            } else {
                // Find corresponding button
                const btns = document.querySelectorAll('.tab-btn');
                if (tabName === 'races') btns[0].classList.add('active');
                else if (tabName === 'add') btns[1].classList.add('active');
            }

            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // Add escape helper for XSS prevention
        const esc = str => String(str ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');

        // === Race List ===
        let races = [];

        async function loadRaces() {
            try {
                const response = await fetch('/api/races/all', {
                    headers: {
                        'Authorization': 'Bearer ' + sessionStorage.getItem('ADMIN_SECRET')
                    }
                });
                if (response.ok) {
                    races = await response.json();
                    renderRaceList();
                }
            } catch (error) {
                console.error('Failed to load races:', error);
            }
        }

        function renderRaceList() {
            const list = document.getElementById('raceList');
            if (races.length === 0) {
                list.innerHTML = '<p class="admin-table-desc" style="text-align: center; padding: 40px;">No races found. Add your first race!</p>';
                return;
            }

            const today = new Date().toISOString().split('T')[0];

            list.innerHTML = races.map(race => {
                const isPastDraft = race.status === 'draft' && race.race_date && race.race_date < today;
                const readyBadge = isPastDraft ? '<span class="status-draft" style="font-size: 10px; margin-left: 8px;">üìÖ Ready to Update</span>' : '';

                return `
        <div class="race-card" style="${isPastDraft ? 'border-left: 3px solid #f59e0b;' : ''}">
          <div class="race-card-info">
            <h3>${esc(race.name)}${readyBadge}</h3>
            <p>${esc(formatDate(race.race_date))} ‚Ä¢ ${esc(race.city || '')}, ${esc(race.state || 'WA')}</p>
          </div>
          <div class="race-card-status">
            <span class="status-badge status-${race.status}">${esc(race.status)}</span>
            <a href="../events/race-detail.html?id=${esc(race.id)}" target="_blank" class="edit-btn admin-btn-outline">View Live</a>
            <button class="edit-btn" onclick="editRace('${esc(race.id)}')">Edit</button>
          </div>
        </div>
      `;
            }).join('');
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'TBA';
            return new Date(dateStr).toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function editRace(id) {
            const race = races.find(r => r.id === id);
            if (!race) return;

            switchTab('add');

            const form = document.getElementById('raceForm');
            form.dataset.editingId = id;

            // Fill basic info
            if (document.getElementById('raceName')) {
                document.getElementById('raceName').value = race.name || '';
            } else {
                console.error('CRITICAL: raceName input not found in DOM!');
            }
            form.raceDate.value = race.race_date || '';
            form.isActive.checked = race.is_visible;
            form.registrationOpen.checked = race.registration_open;
            form.isFeatured.checked = race.is_featured;
            form.waitlistEnabled.checked = race.waitlist_enabled;

            // Text fields
            if (form.city) form.city.value = race.city || '';
            if (form.state) form.state.value = race.state || 'WA';
            if (form.venue) form.venue.value = race.venue || '';
            if (form.distances) form.distances.value = race.distances || '';

            // Show View Live button and Delete section
            document.getElementById('viewLiveBtn').style.display = 'inline-block';
            document.getElementById('deleteSection').style.display = 'block';


            // Handle distances
            const distanceList = document.getElementById('distanceList');
            distanceList.innerHTML = '';
            if (race.race_distances && race.race_distances.length > 0) {
                race.race_distances.forEach(d => {
                    addDistanceWithValue(d.name, d.distance_value, d.capacity, d.base_price, d.start_time, d.standard_price);
                });
            } else {
                addDistance();
            }



            if (race.thumbnail_url) {
                const preview = document.getElementById('thumbnailPreview');
                preview.src = race.thumbnail_url;
                preview.style.display = 'block';
                document.getElementById('thumbnailPlaceholder').style.display = 'none';
                document.getElementById('thumbnailUploadArea').classList.add('has-image');
                document.getElementById('thumbnailClearBtn').style.display = 'inline-block';
            }


        }

        function addDistanceWithValue(name = '', distance = '', capacity = '', price = '', startTime = '', standardPrice = '') {
            // Convert null/undefined to empty strings for form inputs
            name = name ?? '';
            distance = distance ?? '';
            capacity = (capacity === null || capacity === undefined) ? '' : capacity;
            price = (price === null || price === undefined) ? '' : price;
            startTime = startTime ?? '';
            standardPrice = (standardPrice === null || standardPrice === undefined) ? '' : standardPrice;

            const list = document.getElementById('distanceList');
            const item = document.createElement('div');
            item.className = 'distance-item';

            const distanceOptions = [
                { value: '', label: '-- Select Distance --' },
                { value: '5K', label: '5K' },
                { value: '10K', label: '10K' },
                { value: '15K', label: '15K' },
                { value: 'Half Marathon', label: 'Half Marathon' },
                { value: 'Marathon', label: 'Marathon' },
                { value: '50K Ultra', label: '50K Ultra' },
                { value: '100K Ultra', label: '100K Ultra' },
                { value: '100 Mile', label: '100 Mile' },
                { value: 'Kids Run', label: 'Kids Run' },
                { value: '1 Mile', label: '1 Mile' },
                { value: 'Sprint Triathlon', label: 'Sprint Triathlon' },
                { value: 'Olympic Triathlon', label: 'Olympic Triathlon' },
                { value: 'Half Ironman', label: 'Half Ironman' },
                { value: 'Trail Run', label: 'Trail Run' },
                { value: 'Virtual', label: 'Virtual' }
            ];

            const optionsHtml = distanceOptions.map(opt =>
                `<option value="${opt.value}" ${opt.value === name ? 'selected' : ''}>${opt.label}</option>`
            ).join('');

            item.innerHTML = `
        <div>
          <label>Distance Type</label>
          <select name="distanceName[]" aria-label="Distance Type" onchange="autoFillDistance(this)" class="admin-lock-input">
            ${optionsHtml}
          </select>
        </div>
        <div>
          <label>Distance Value</label>
          <input type="text" name="distanceValue[]" value="${distance}" placeholder="e.g., 3.1 miles">
        </div>
        <div>
          <label>Capacity</label>
          <input type="number" name="distanceCapacity[]" value="${capacity}" placeholder="500">
        </div>
        <div>
          <label>Base Price</label>
          <input type="number" name="distancePrice[]" value="${price}" placeholder="75" step="0.01">
        </div>
        <div>
          <label>Standard Price</label>
          <input type="number" name="distanceStandardPrice[]" value="${standardPrice}" placeholder="90" step="0.01">
        </div>
        <div>
          <label>Start Time</label>
          <input type="time" name="distanceStartTime[]" value="${startTime}">
        </div>
        <button type="button" class="remove-distance" onclick="removeDistance(this)">√ó</button>
      `;
            list.appendChild(item);
        }

        // === Distance Repeater ===
        function addDistance() {
            addDistanceWithValue();
        }

        function removeDistance(btn) {
            const items = document.querySelectorAll('.distance-item');
            if (items.length > 1) {
                btn.parentElement.remove();
            }
        }




        // Standard distance values - auto-fills when distance type is selected
        const distanceValues = {
            '5K': '3.1 miles',
            '10K': '6.2 miles',
            '15K': '9.3 miles',
            'Half Marathon': '13.1 miles',
            'Marathon': '26.2 miles',
            '50K Ultra': '31.1 miles',
            '100K Ultra': '62.1 miles',
            '100 Mile': '100 miles',
            '1 Mile': '1 mile',
            'Kids Run': '', // Variable - user enters
            'Sprint Triathlon': '', // Variable
            'Olympic Triathlon': '', // Variable
            'Half Ironman': '70.3 miles total',
            'Trail Run': '', // Variable
            'Virtual': '' // Variable
        };

        // Auto-fill distance value when distance type is selected
        function autoFillDistance(selectElement) {
            const distanceItem = selectElement.closest('.distance-item');
            const valueInput = distanceItem.querySelector('input[name="distanceValue[]"]');
            const selectedDistance = selectElement.value;

            if (distanceValues[selectedDistance]) {
                valueInput.value = distanceValues[selectedDistance];
            } else if (selectedDistance === '') {
                valueInput.value = '';
            }
            // If no preset value, leave the field as-is (user can enter custom)
        }



        // === Form Actions ===
        function clearForm() {
            if (confirm('Clear all form data?')) {
                const form = document.getElementById('raceForm');
                form.reset();
                delete form.dataset.editingId;
                document.getElementById('viewLiveBtn').style.display = 'none';
                document.getElementById('deleteSection').style.display = 'none';
                clearImage('thumbnail');

                // Clear repeaters
                document.getElementById('distanceList').innerHTML = '';
                addDistance(); // Add one default distance

            }
        }

        // === Delete Functions ===
        function showDeleteConfirm() {
            document.getElementById('deleteStep1').style.display = 'none';
            document.getElementById('deleteStep2').style.display = 'block';
        }

        function hideDeleteConfirm() {
            document.getElementById('deleteStep1').style.display = 'block';
            document.getElementById('deleteStep2').style.display = 'none';
        }

        async function finalDeleteRace() {
            const form = document.getElementById('raceForm');
            const editingId = form.dataset.editingId;

            if (!editingId) return;

            try {
                const response = await fetch(`/api/races/${editingId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + sessionStorage.getItem('ADMIN_SECRET')
                    }
                });

                if (response.ok) {
                    alert('Race deleted permanently.');
                    // Manually clear form elements and hide sections
                    form.reset();
                    delete form.dataset.editingId;
                    document.getElementById('viewLiveBtn').style.display = 'none';
                    document.getElementById('deleteSection').style.display = 'none';
                    hideDeleteConfirm(); // Reset the buttons for next time
                    switchTab('races');
                    loadRaces();
                } else {
                    const data = await response.json();
                    alert('Failed to delete race: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete race: ' + error.message);
            }
        }

        async function saveRace(status = 'active') {
            const form = document.getElementById('raceForm');
            const formData = new FormData(form);
            const editingId = form.dataset.editingId;

            // Generate a temporary ID if this is a new race
            const raceId = editingId || 'temp-' + Date.now();

            // Upload images first
            let thumbnailImageUrl = null;

            const thumbnailFile = document.getElementById('thumbnailImage').files[0];


            if (thumbnailFile) {
                try {
                    const uploadFormData = new FormData();
                    uploadFormData.append('file', thumbnailFile);
                    uploadFormData.append('type', 'thumbnail');
                    uploadFormData.append('raceId', raceId);

                    const uploadRes = await fetch('/api/races/upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + sessionStorage.getItem('ADMIN_SECRET')
                        },
                        body: uploadFormData
                    });

                    if (uploadRes.ok) {
                        const uploadData = await uploadRes.json();
                        thumbnailImageUrl = uploadData.url;
                    } else {
                        const errorText = await uploadRes.text();
                        console.error('Thumbnail upload failed:', errorText);
                        alert('Thumbnail image upload failed: ' + errorText);
                    }
                } catch (err) {
                    console.error('Thumbnail upload error:', err);
                    alert('Thumbnail image upload error: ' + err.message);
                }
            }





            // Extract distances
            const dNames = formData.getAll('distanceName[]');
            const dValues = formData.getAll('distanceValue[]');
            const dCapacities = formData.getAll('distanceCapacity[]');
            const dPrices = formData.getAll('distancePrice[]');
            const dStandardPrices = formData.getAll('distanceStandardPrice[]');
            const dStartTimes = formData.getAll('distanceStartTime[]');

            const distances = dNames.map((name, i) => ({
                name,
                distance_value: dValues[i],
                capacity: parseInt(dCapacities[i]) || null,
                base_price: parseFloat(dPrices[i]) || 0,
                standard_price: parseFloat(dStandardPrices[i]) || null,
                start_time: dStartTimes[i] || null
            })).filter(d => d.name);

            const payload = {
                name: formData.get('raceName'),
                race_date: formData.get('raceDate'),
                race_type: formData.get('raceType'),
                venue: formData.get('venue'),
                city: formData.get('city'),
                state: formData.get('state'),
                distances_display: formData.get('distances'),
                registration_url: window.formatExternalUrl(formData.get('registrationUrl')),
                status: status,
                is_visible: formData.get('isActive') === 'on',
                is_featured: formData.get('isFeatured') === 'on',
                waitlist_enabled: formData.get('waitlistEnabled') === 'on',
                thumbnail_url: thumbnailImageUrl || (editingId ? races.find(r => r.id === editingId)?.thumbnail_url : null),
                distances: distances
            };

            try {
                const url = editingId ? `${RACES_ENDPOINT}/${editingId}` : RACES_ENDPOINT;
                const method = editingId ? 'PUT' : 'POST';
                const authSecret = sessionStorage.getItem('ADMIN_SECRET');

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authSecret
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok) {
                    alert('Race saved successfully!');
                    if (confirm('Race saved! Would you like to view the live page?')) {
                        window.open(`../events/race-detail.html?id=${result.id || editingId}`, '_blank');
                    }
                    clearForm();
                    switchTab('races');
                    loadRaces();
                } else {
                    alert('Failed to save race: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Save error:', e);
                alert('Error saving race: ' + e.message);
            }
        }

        function saveDraft() {
            saveRace('draft');
        }

        document.getElementById('raceForm').addEventListener('submit', function (e) {
            e.preventDefault();
            saveRace('active');
        });


        // === Image Upload & Preview ===
        function validateImage(file) {
            const maxSize = 5 * 1024 * 1024; // 5MB
            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];

            if (!allowedTypes.includes(file.type)) {
                alert('Please use JPG, PNG, or WebP images only');
                return false;
            }

            if (file.size > maxSize) {
                alert('Image must be under 5MB');
                return false;
            }

            return true;
        }


        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            const placeholder = document.getElementById(previewId.replace('Preview', 'Placeholder'));
            const uploadArea = document.getElementById(previewId.replace('Preview', 'UploadArea'));
            const clearBtn = document.getElementById(previewId.replace('Preview', 'ClearBtn'));

            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (!validateImage(file)) {
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                    uploadArea.classList.add('has-image');
                    clearBtn.style.display = 'inline-block';
                };

                reader.readAsDataURL(file);
            }
        }

        function clearImage(type) {
            const input = document.getElementById(type + 'Image');
            const preview = document.getElementById(type + 'Preview');
            const placeholder = document.getElementById(type + 'Placeholder');
            const uploadArea = document.getElementById(type + 'UploadArea');
            const clearBtn = document.getElementById(type + 'ClearBtn');

            if (input) input.value = '';
            if (preview) {
                preview.src = '';
                preview.style.display = 'none';
            }
            if (placeholder) placeholder.style.display = 'block';
            if (uploadArea) uploadArea.classList.remove('has-image');
            if (clearBtn) clearBtn.style.display = 'none';
        }



        // Initialize with empty slots if needed
        document.addEventListener('DOMContentLoaded', function () {
            if (document.getElementById('gallerySlots') && document.querySelectorAll('.gallery-slot').length === 0) {
                if (typeof window.addGallerySlot === 'function') window.addGallerySlot();
            }
            if (document.getElementById('carouselSlots') && document.querySelectorAll('.carousel-slot').length === 0) {
                // We don't necessarily need empty carousel slots by default, but we can add one
                // addCarouselSlot();
            }
        });

        // Expose functions to window for inline HTML onclick handlers
        window.switchTab = switchTab;
        window.editRace = editRace;
        window.addDistanceWithValue = addDistanceWithValue;
        window.addDistance = addDistance;
        window.removeDistance = removeDistance;
        window.autoFillDistance = autoFillDistance;
        window.clearForm = clearForm;
        window.showDeleteConfirm = showDeleteConfirm;
        window.hideDeleteConfirm = hideDeleteConfirm;
        window.finalDeleteRace = finalDeleteRace;
        window.saveRace = saveRace;
        window.saveDraft = saveDraft;
        window.previewImage = previewImage;
        window.clearImage = clearImage;

        // Provide stubs for missing functions referenced in HTML
        window.addBeneficiary = function () { console.warn('addBeneficiary not implemented'); };
        window.addSponsor = function () { console.warn('addSponsor not implemented'); };

        // === Drag and Drop ===
    </script>


</body>

</html>